- name: Generate SUMMARY.md
  run: |
    cat > generate-summary.py << 'SCRIPT_END'
    import os
    from pathlib import Path
    import re
    
    def get_title(filepath):
        """Extract title from markdown file"""
        try:
            with open(filepath, 'r') as f:
                first_line = f.readline()
                if first_line.startswith('# '):
                    return first_line[2:].strip()
        except:
            pass
        return Path(filepath).stem.replace('-', ' ').replace('_', ' ').title()
    
    def process_directory(path, base_path, indent=0):
        """Recursively process directory and return summary lines"""
        lines = []
        items = []
        
        # Collect all items in this directory
        for item in sorted(Path(path).iterdir()):
            if item.name.startswith('.') or item.name == 'SUMMARY.md':
                continue
            
            rel_path = item.relative_to(base_path)
            
            if item.is_file() and item.suffix == '.md':
                title = get_title(item)
                if item.name.lower() == 'readme.md':
                    # README becomes the section parent
                    items.insert(0, ('readme', title, str(rel_path), item))
                else:
                    items.append(('file', title, str(rel_path), item))
            elif item.is_dir():
                items.append(('dir', item.name, None, item))
        
        # Process items
        readme_processed = False
        for item_type, title, rel_path, item_path in items:
            if item_type == 'readme':
                # This directory's README
                lines.append(f"{'    ' * indent}- [{title}](./{rel_path})\n")
                readme_processed = True
            elif item_type == 'file':
                # Regular file - indent if we had a README
                extra_indent = 1 if readme_processed else 0
                lines.append(f"{'    ' * (indent + extra_indent)}- [{title}](./{rel_path})\n")
            elif item_type == 'dir':
                # Subdirectory
                subdir_lines = process_directory(item_path, base_path, 
                                                indent + (1 if readme_processed else 0))
                if subdir_lines:  # Only add if directory has content
                    # Check if subdir has README as first item
                    has_readme = any('README.md' in str(f) for f in item_path.glob('*.md') 
                                   if f.name.lower() == 'readme.md')
                    if not has_readme:
                        # No README - add section title
                        section_title = title.replace('-', ' ').replace('_', ' ').title()
                        lines.append(f"{'    ' * (indent + (1 if readme_processed else 0))}- {section_title}\n")
                    lines.extend(subdir_lines)
        
        return lines
    
    # Generate summary
    src_path = Path('src')
    lines = ["# Summary\n\n"]
    
    # Check for root README
    root_readme = src_path / 'README.md'
    if root_readme.exists():
        lines.append(f"[Introduction](./README.md)\n\n")
    
    # Process all items in src
    for item in sorted(src_path.iterdir()):
        if item.name.startswith('.') or item.name == 'SUMMARY.md' or item.name == 'README.md':
            continue
        
        if item.is_file() and item.suffix == '.md':
            title = get_title(item)
            lines.append(f"- [{title}](./{item.name})\n")
        elif item.is_dir():
            subdir_lines = process_directory(item, src_path, 0)
            lines.extend(subdir_lines)
    
    # Write the file
    with open('src/SUMMARY.md', 'w') as f:
        f.writelines(lines)
    
    print("SUMMARY.md generated successfully!")
    SCRIPT_END
    
    python generate-summary.py
